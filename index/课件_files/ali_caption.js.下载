var videoCaptionOption={splitArrData:[],getCaptionArrBase:100,currentCaptionText:"",renderEleId:"container",coursewareMin:"flash_player",renderEleWidth:0,position:0,captionFontSize:26};var alplayerCaption={parsers:{srt:function(){}},utils:{}};var WINDOW=window,UNDEFINED="undefined",STRING="string",OBJECT="object",TRUE=true,FALSE=false;function loadVideoCaption(b,a,d){if(typeof(b)==="undefined"||isIEBrowserNoIE11()){return}if(typeof(a)!="undefined"&&a!=""){videoCaptionOption.renderEleId=a;var c=b.split("?");var f=c[1].split("&");var j="";for(var e in f){var h=f[e].toLowerCase();if(h.indexOf("metaid")>-1){continue}if(h.indexOf("path")>-1){var g=h.split("/");g[0]="";f[e]="path="+g.join("/").substring(1)}j=j+f[e]+"&"}b=c[0]+"?"+j}if(typeof(d)!="undefined"&&d!=""){videoCaptionOption.coursewareMin=d}captionAjax(b,function(i){xmlReadHandler(i)},function(i){console.info(i)},true)}function xmlReadHandler(a){if(a.responseText==""){return}var b=srtConvert(a.responseText);videoCaptionOption.splitArrData=splitArr(b,videoCaptionOption.getCaptionArrBase);renderCaption();changedFontSize();videoCaptionOption.renderEleWidth=document.getElementById(videoCaptionOption.renderEleId).clientWidth}function splitArr(c,d){d=typeof(d)=="undefined"||d==null?1000:d;if(c==null||c.length==0){return null}var l=0;var f=c.length;var h=Math.floor(f/d);if(h==0){return new Array(c)}var g=new Array();var j=new Array();for(var e in c){var k=c[e];var a=k.begin;var m=Math.floor(a);var b=Math.floor(m/videoCaptionOption.getCaptionArrBase);j=g[b];if(typeof(j)=="undefined"){j=new Array();var n=g[b-1];if(typeof(n)!="undefined"){n.push(k);g[b-1]=n}}j.push(k);g[b]=j}return g}function updateCurCaptionText(a){var e=document.getElementById("caption_pos"),d=document.getElementById("screen_player");if(e&&d){e.style.bottom=(d.style.display==="none"||d.className.indexOf("video_con_hide")>-1)?"20px":"64px"}if(videoCaptionOption.splitArrData==null||videoCaptionOption.splitArrData.length==0){return}var b=Math.floor(a/videoCaptionOption.getCaptionArrBase);var c=videoCaptionOption.splitArrData[b];if(typeof(c)=="undefined"){setCaptionText("");return}selectCaption(c,a);videoCaptionOption.position=a}function selectCaption(b,a){var e=-1;for(var c=0;c<b.length;c++){if(b[c]["begin"]<=a&&(c==b.length-1||b[c+1]["begin"]>=a)){e=c;break}}var f=b[e];var d="";if(typeof(f)!="undefined"&&f!=null){d=f.text}setCaptionText(d)}function resizeFontSize(){var a=videoCaptionOption.renderEleWidth;var d=document.getElementById(videoCaptionOption.renderEleId).clientWidth;if(a==d){return}var b=0;if(d<500){b=14}else{if(d<800){b=20}else{if(d<1000){b=26}else{if(d<1500){b=35}else{b=40}}}}var c=document.getElementById("caption_pos_txt");c.setAttribute("style","font-size:"+b+"px");videoCaptionOption.captionFontSize=b;videoCaptionOption.renderEleWidth=d}function changedFontSize(){resizeFontSize();setTimeout(function(){changedFontSize()},100)}function srtConvert(e){var b=[{begin:0,text:""}];e=captionTrim(e);var d=e.split("\r\n\r\n");if(d.length==1){d=e.split("\n\n")}for(var a=0;a<d.length;a++){if(d[a]=="WEBVTT"){continue}var c=captionEntry(d[a]);if(c.text){b.push(c);if(c.end){b.push({begin:c.end,text:""});delete c.end}}}if(b.length>1){return b}}function captionTrim(a){return a.replace(/^\s*/,"").replace(/\s*$/,"")}function captionEntry(f){var e={};var g=f.split("\r\n");if(g.length==1){g=f.split("\n")}try{var a=1;if(g[0].indexOf(" --> ")>0){a=0}var c=g[a].indexOf(" --> ");if(c>0){e.begin=captionToSeconds(g[a].substr(0,c));e.end=captionToSeconds(g[a].substr(c+5))}if(g[a+1]){e.text=g[a+1];for(var d=a+2;d<g.length;d++){e.text+="<br/>"+g[d]}}}catch(b){}return e}function convertCaptionShowEle(){if(videoCaptionOption.splitArrData.length==0){return}var a=videoCaptionOption.coursewareMin;var b=videoCaptionOption.renderEleId;videoCaptionOption.renderEleId=a;videoCaptionOption.coursewareMin=b;document.getElementById("caption_pos").parentNode.removeChild(document.getElementById("caption_pos"));renderCaption();updateCurCaptionText(videoCaptionOption.position);resizeFontSize()}function setCaptionText(b){var a=document.getElementById("caption_pos_txt");if(a==null){return}var c=a.innerText;if(c==b){return}a.innerHTML=b}function renderCaption(){var b="<div class='caption_container'><span id='caption_pos_txt' style='font-size: "+videoCaptionOption.captionFontSize+"px;'></span></div>";var c=document.createElement("div");c.setAttribute("id","caption_pos");c.setAttribute("class","caption_pos");c.innerHTML=b;var a=document.getElementById(videoCaptionOption.renderEleId);a.appendChild(c)}function captionToSeconds(c){c=c.replace(",",".");var a=c.split(":");var b=0;if(c.slice(-1)=="s"){b=parseFloat(c)}else{if(c.slice(-1)=="m"){b=parseFloat(c)*60}else{if(c.slice(-1)=="h"){b=parseFloat(c)*3600}else{if(a.length>1){b=parseFloat(a[a.length-1]);b+=parseFloat(a[a.length-2])*60;if(a.length==3){b+=parseFloat(a[a.length-3])*3600}}else{b=parseFloat(c)}}}}return b}function captionExists(a){switch(typeof(a)){case STRING:return(a.length>0);case OBJECT:return(a!==null);case UNDEFINED:return FALSE}return TRUE}function captionExtend(){var b=Array.prototype.slice.call(arguments,0);if(b.length>1){var d=b[0],a=function(f,e){if(e!==undefined&&e!==null){d[f]=e}};for(var c=1;c<b.length;c++){captionForeach(b[c],a)}return d}return null}function captionTypeOf(b){var a=typeof b;if(a===OBJECT){if(!b){return"null"}return(b instanceof Array)?"array":a}return a}function captionTranslateEventResponse(c,a){var e=captionExtend({},a);if(c==alplayerCaption.events.alplayerCaption_FULLSCREEN&&!e.fullscreen){e.fullscreen=(e.message==="true");delete e.message}else{if(typeof e.data==OBJECT){var d=e.data;delete e.data;e=captionExtend(e,d)}else{if(typeof e.metadata==OBJECT){captionDeepReplaceKeyName(e.metadata,["__dot__","__spc__","__dsh__","__default__"],["."," ","-","default"])}}}var b=["position","duration","offset"];captionForeach(b,function(f,g){if(e[g]){e[g]=Math.round(e[g]*1000)/1000}});return e}function captionDeepReplaceKeyName(d,b,a){switch(captionTypeOf(d)){case"array":for(var c=0;c<d.length;c++){d[c]=captionDeepReplaceKeyName(d[c],b,a)}break;case OBJECT:captionForeach(d,function(g,k){var j,h;if(b instanceof Array&&a instanceof Array){if(b.length!=a.length){return}else{j=b;h=a}}else{j=[b];h=[a]}var e=g;for(var f=0;f<j.length;f++){e=e.replace(new RegExp(b[f],"g"),a[f])}d[e]=captionDeepReplaceKeyName(k,b,a);if(g!=e){delete d[g]}});break}return d}function captionForeach(b,a){var c,d;for(c in b){if(captionTypeOf(b.hasOwnProperty)=="function"){if(b.hasOwnProperty(c)){d=b[c];a(c,d)}}else{d=b[c];a(c,d)}}}function captionAjax(g,e,a,f){var c;var d=false;if(g.indexOf("#")>0){g=g.replace(/#.*$/,"")}if(captionIsCrossdomain(g)&&captionExists(WINDOW.XDomainRequest)){c=new WINDOW.XDomainRequest();c.onload=captionAjaxComplete(c,g,e,a,f);c.ontimeout=c.onprogress=function(){};c.timeout=5000}else{if(captionExists(WINDOW.XMLHttpRequest)){c=new WINDOW.XMLHttpRequest();c.onreadystatechange=captionReadyStateChangeHandler(c,g,e,a,f)}else{if(a){a("",g,c)}return c}}if(c.overrideMimeType){c.overrideMimeType("text/xml")}c.onerror=captionAjaxError(a,g,c);try{c.open("GET",g,TRUE)}catch(b){d=true}setTimeout(function(){if(d){if(a){a(g,g,c)}return}try{c.send()}catch(h){if(a){a(g,g,c)}}},0);return c}function captionIsCrossdomain(a){return(a&&a.indexOf("://")>=0)&&(a.split("/")[2]!=WINDOW.location.href.split("/")[2])}function captionAjaxError(a,c,b){return function(){a("Error loading file",c,b)}}function captionReadyStateChangeHandler(b,e,c,a,d){return function(){if(b.readyState===4){switch(b.status){case 200:captionAjaxComplete(b,e,c,a,d)();break;case 404:a("File not found",e,b)}}}}function captionAjaxComplete(b,e,c,a,d){return function(){var f,i;if(d){c(b)}else{try{f=b.responseXML;if(f){i=f.firstChild;if(f.lastChild&&f.lastChild.nodeName==="parsererror"){if(a){a("Invalid XML",e,b)}return}}}catch(h){}if(f&&i){return c(b)}var g=captionParseXML(b.responseText);if(g&&g.firstChild){b=captionExtend({},b,{responseXML:g})}else{if(a){a(b.responseText?"Invalid XML":e,e,b)}return}c(b)}}}function captionParseXML(a){var b;try{if(WINDOW.DOMParser){b=(new WINDOW.DOMParser()).parseFromString(a,"text/xml");if(b.childNodes&&b.childNodes.length&&b.childNodes[0].firstChild.nodeName=="parsererror"){return}}else{b=new WINDOW.ActiveXObject("Microsoft.XMLDOM");b.async="false";b.loadXML(a)}}catch(c){return}return b}function isIEBrowserNoIE11(){var b=window.navigator.userAgent.toLowerCase();var a=b&&/msie/.test(b);return a};