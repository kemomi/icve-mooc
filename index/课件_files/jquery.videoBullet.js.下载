(function(k){var p=e();var q=false;var o=false;var h=false;var n=[];var j=[];var d=[];var c=[];var g=null;var i=null;var l=0;k.fn.videoBullet=function(s){var v=this;try{s=k.extend({},k.fn.videoBullet.defaults,s||{});k(v).data("options",s);if(!q){q=true;f.init(s)}if(o&&n&&n.length>0){f.playBullet(s);var r=s.timePoint;if(r>=l){l=r}else{if(!s.pause&&r+s.dragTimeLong<=l){l=r;u()}else{if(!s.pause&&r-s.dragTimeLong>=l){}}}}}catch(t){console.error(t.name+": "+t.message)}function u(){j=[];j=b(j,n);var w=null;for(var x=0;x<j.length;x++){w=j[x];if(w.timePoint<parseInt(r)){a(j,w)}}}};var f={init:function(r){this.openCloseBullet(r);this.speed(r);this.opacity(r);this.area(r);this.defaultBullet();this.initSendEvent(r);this.favour();this.report();this.pos(".bullet-setup-pop",-20);this.pos(".bullet-postEmo-pop",-10);this.popup(".bullet-setup-btn",".bullet-setup-pop","bullet-setup-btnCur");this.popup(".bullet-postEmo",".bullet-postEmo-pop","bullet-postEmo-cur");this.popup(".bullet-postExp",".bullet-postExp-pop","bullet-postExp-cur");this.popup(".bullet-record-btn",".bullet-record-pop","bullet-recordOn");this.bulletHistory()},openCloseBullet:function(r){var s=this;k("#switch_video_c").click(function(){k(this).toggleClass("switch-on");if(k(this).is(".switch-on")){o=true;s.getBulletData(r);k(".bulletScreen").show();k.cookie(r.cookieKey.open,"open")}else{k(".bulletScreen").hide();o=false;k.cookie(r.cookieKey.open,"close")}})},getBulletData:function(s){var t=this;var r=s.timePoint;if(r&&!isNaN(r)){r=parseInt(r)}else{r=null}k.ajax({url:p+"/learn/learnCourseware/queryVideoBullet.json",type:"post",data:{"params.itemId":itemId,"params.timePoint":r},dataType:"json",async:true,cache:false,success:function(u){if(u&&u.data.success==="true"){n=u.data.bulletList;t.parseBulletData(s,n)}},error:function(){console.log("查询弹幕数量请求失败！")}})},parseBulletData:function(B,t){var A=null;var y=null;var r=null;var x=0;var u=0;var w=0;var v=0;d=[];c=[];var s=k.cookie(B.cookieKey.area)||"top";for(var z=0;z<t.length;z++){r=t[z];x=parseInt(r.sequence);u=r.timePoint;w=x%B.roadCount;if(w==0){w=B.roadCount}if(s=="bottom"){w+=5}if(A!=(u+"_"+w)){A=u+"_"+w;r.bulletRoad=w;d.push(r)}v=x%B.roadCountAll;if(v==0){v=B.roadCountAll}if(y!=(u+"_"+v)){y=u+"_"+v;r.bulletRoad=v;c.push(r)}}n=d;j=[];j=b(j,n)},playBullet:function(u){var v=this;k(v).data("options",u);v.fullScreenHandle(u);if(u.pause){k(".bulletScreen").find(".bullet-item").each(function(){k(this).pause();k(this).off("mouseenter")});return false}else{var t=k(".bulletScreen").find(".bullet-item");if(g){var r=k(".bulletScreen").find("bullet_track"+i);t=t.not(r)}k.each(t,function(){var w=k(this).attr("bullet_track");if(w!=i){k(this).resume()}});var s=u.timePoint;if(s>0&&n&&n.length>0){v.show(j,u)}v.hoverPause(u)}},show:function(E,t){var D=this;var K=null;for(var G=0;G<E.length;G++){K=E[G];var v=K.timePoint;var r=t.timePoint;if(t.nowSend||(parseInt(r)==v&&K.reportNum<10)){if(!t.nowSend){a(E,K)}var J=k.cookie(t.cookieKey.area)||"top";var H=k.cookie(t.cookieKey.speed)||10;if(isNaN(H)){H=10}var s=(k.cookie(t.cookieKey.opacity)||80);var C=t.screenWidth();var w=t.roadCount;if(J=="all"){w=t.roadCountAll}var F=null;if(K.sequence){var y=parseInt(K.sequence);F=y%w}if(t.nowSend){F=Math.round(Math.random()*w)}if(F==0){F=w}if(J=="bottom"){F+=5}if(F==i){continue}var I=k("#bullet_screen").find(".bullet_track"+F+":last");if(I.length>0){var u=k(I).css("left").replace("px","");var x=k(I).css("width").replace("px","");var A=parseInt(u)+parseInt(x);if(A>C){C=A}}var z='<div class="bullet-item bullet_ready bullet_track'+F+'" id="bulletId_'+K.id+'" bullet_track="'+F+'" style="pointer-events:auto; z-index:999; visibility:visible; display:inline-block; opacity: '+s+"; left:"+C+'px;" bullet_time="'+v+'" video_time="'+r+'">';if(K.loginId!=K.curLoginId){z+='    <a href="javascript:void(0);" class="bullet-report-lg">举报</a>'}z+='    <div class="bullet-itemIn">';z+='       <span class="bullet-item-txt">'+K.content+"</span>";z+='       <a href="javascript:void(0);" class="bullet-thumbup-lg"></a>';z+='       <span class="bullet-thumbup-num">'+(K.favourNum>0?K.favourNum:"")+"</span>";z+="    </div>";z+='    <span class="bullet-like">';z+='       <i class="bullet-like-ico"></i>';z+='       <span class="bullet-like-num">+1</span>';z+="    </span>";z+="</div>";var B=k(z);k(".bulletScreen").append(B);if(K.favourNum>10){B.addClass("bullet-hotitem")}if(K.loginId==K.curLoginId){B.addClass("bullet-myitem")}B.stop().animate({left:"-10px"},H*1000,"linear",function(){k(this).remove()});if(t.nowSend||h){if(t.pause){B.pause()}else{h=false;B.resume()}}}}},hoverPause:function(){var r=this;k(".bulletScreen").off("mouseenter mouseleave",".bullet-item");k(".bulletScreen").on("mouseenter mouseleave",".bullet-item",function(t){if(t.type=="mouseenter"){var s=k(r).data("options");g=this;i=k(this).attr("bullet_track");k(".bulletScreen").find(".bullet_track"+i).pause()}else{var s=k(r).data("options");g=null;i=null;if(!s.pause){k(".bulletScreen").find(".bullet_track"+i).resume()}}})},fullScreenHandle:function(r){if(r.fullscreen){r.fullscreenPlay()}else{r.exitFunllscreenPlay()}},speed:function(s){var r=k.cookie(s.cookieKey.speed)||15;if(isNaN(r)){r=15}k("#slider-speed").slider({range:"min",value:r||15,min:1,max:30,slide:function(t,u){k("#speed").val(u.value+"秒");k(".bulletScreen").find(".bullet-item").stop().animate({left:"-"+s.screenWidth()+"px"},u.value*1000,"linear",function(){k(this).remove()})},stop:function(t,u){k.cookie(s.cookieKey.speed,u.value)}});r=k("#slider-speed").slider("value");k("#speed").val(r+"秒");k.cookie(s.cookieKey.speed,r)},opacity:function(r){var s=(k.cookie(r.cookieKey.opacity)*100)||100;k("#slider-opacity").slider({range:"min",value:1,min:1,max:100,slide:function(t,u){var v=1-u.value/100;k("#opacity").val(u.value+"%");k(".bulletScreen").find(".bullet-item").css({opacity:v.toFixed(2)})},stop:function(t,u){var v=1-u.value/100;k.cookie(r.cookieKey.opacity,v.toFixed(2))}});opacitySilder=k("#slider-opacity").slider("value");var s=1-opacitySilder/100;k("#opacity").val(opacitySilder+"%");k.cookie(r.cookieKey.opacity,s.toFixed(2))},area:function(r){k('div[area="all"],div[area="top"],div[area="bottom"]').click(function(){k(".bullet-areaWrap").removeClass("bullet-areaCur");k(this).addClass("bullet-areaCur");var t=k(this).attr("area");k.cookie(r.cookieKey.area,t);if(t=="top"||t=="bottom"){r.roadCount=5;n=d}else{r.roadCount=10;n=c}});var s=k.cookie(r.cookieKey.area)||"top";k(".bullet-areaWrap").removeClass("bullet-areaCur");k('div[area="'+s+'"]').addClass("bullet-areaCur");k.cookie(r.cookieKey.area,s);if(s=="top"||s=="bottom"){r.roadCount=5}else{r.roadCount=10}},defaultBullet:function(){k(".bullet-postInput").on("focus",function(){k(this).attr("bullet_input","true");k(this).parents(".bullet-postWrap").addClass("bullet-postOn")}).on("blur",function(){k(this).removeAttr("bullet_input");k(this).parents(".bullet-postWrap").removeClass("bullet-postOn")});k(".bullet-emo-li").on("click",function(){var r=k(this).find(".bullet-emo-link").text();k(".bullet-postInput").val(r).focus()})},initSendEvent:function(r){var s=this;k(".bullet-postInput").keyup(function(){var u=k(".bullet-postInput").val();var t=m(u,25);if(t.length>25){k(".bullet-postInput").val(u.substring(0,t.limitLenPostion))}});k(".bullet-postSubmit").on("click",function(){var x=x||k("#courseId").val();var w=w||k("#itemId").val();var v=jwplayer("container").getPosition();var u=k(".bullet-postInput").val();if(u&&k.trim(u)!=""){var t=k(s).data("options");if(t!=null){r=t}s.send(x,w,u,v,r);s.sendWaitHandle(r)}})},send:function(v,u,s,t,r){var w=this;if(s.indexOf("?")>-1){s=s.replace(/\?/g,"？")}k.ajax({url:p+"/learn/learnCourseware/saveLearnVideoBullet.json",type:"post",data:{"params.courseId":v,"params.itemId":u,"params.content":s,"params.timePoint":parseInt(t)},dataType:"json",async:true,cache:false,success:function(x){if(x){if(x.data.success==="true"){if(x.data.sendBulletStatus=="true"){k(".bullet-postInput").val("").blur();var z=x.data.bulletMap;z.timePoint=z.timePoint+2;r.nowSend=true;r.nowSendPause=true;h=true;var y=[z];w.show(y,r);n.unshift(z);d.unshift(z);c.unshift(z)}else{k(".bullet-postInput").val("发送失败，你已被管理员禁言！")}}}},error:function(){console.log("发送弹幕失败！")}})},sendWaitHandle:function(s){try{var u=this;var w=s.sendWaitTime;var r=null;function v(){r=setTimeout(function(){v()},1000);if(w>0){k(".bullet-postSubmit").off("click");k(".bullet-postSubmit").addClass("font_color_w").val(w+"秒");w--}else{k(".bullet-postSubmit").removeClass("font_color_w").val("发送");u.initSendEvent(s);if(r){clearTimeout(r)}}}v()}catch(t){}},favour:function(){var r=this;k(".bulletScreen").on("click","a[class='bullet-thumbup-lg']",function(){k(this).off("click").addClass("had_favour");var u="";var t=k(this).parents(".bullet-item").attr("id").substring("bulletId_".length);for(var s=0;s<n.length;s++){u=n[s].hadFavour||"0";if(t==n[s].id&&u!="1"){var v=k(this).next().text();v++;k(this).parent().next().fadeIn().animate({top:"-=20px",opacity:"0"},"slow");k(this).next().text(v);r.favourOrReport(t,"1");break}}})},report:function(){var r=this;k(".bulletScreen").on("click","a[class='bullet-report-lg']",function(){k(this).off("click").addClass("had_report");var u="";var t=k(this).parents(".bullet-item").attr("id").substring("bulletId_".length);for(var s=0;s<n.length;s++){u=n[s].hadReport||"0";if(t==n[s].id&&u!="1"){r.favourOrReport(t,"0");break}}})},favourOrReport:function(r,s){k.ajax({url:p+"/learn/learnCourseware/updateLearnVideoBullet.json",type:"post",data:{"params.id":r,"params.favourOrReportFlag":s},dataType:"json",async:true,cache:false,success:function(t){if(t&&t.data.success==="true"){for(var u=0;u<n.length;u++){if(r==n[u].id){if(s=="1"){n[u].hadFavour="1";n[u].favourNum=parseInt(n[u].favourNum||"0")+1}else{n[u].hadReport="1";n[u].reportNum=parseInt(n[u].reportNum||"0")+1}break}}}},error:function(){console.log("赞、举报弹幕请求失败！")}})},popup:function(t,s,r){k(t).click(function(){k(this).toggleClass(r);k(this).siblings(s).fadeToggle();k(this).siblings(s).on("mouseleave",function(){k(this).fadeOut();k(this).siblings(t).removeClass(r)})})},pos:function(s,t){var r=k(s).outerHeight();k(s).css("top",-r+t+"px")},bulletHistory:function(){this.pos(".bullet-record-pop",-10);this.popup("#bullet_record_btn_container",".bullet-record-pop","bullet-recordOn");var r=k('<span class="bullet-tooltip" id="bullet_tooltip">	<i class="arrdn bullet-tooltip-arr" id="bullet_tooltip_arr"></i>	<span class="bullet-tooltip-txt"></span></span>');k(".bullet-recordReport").each(function(s){var t=k(this).children("span").text();k(this).on("mouseover",function(){k(this).append(r);var u=r.width();r.removeAttr("style");r.css("margin-left",-(u/2)+"px");r.children("span").text(t+"人举报");if(s==0){k("#bullet_tooltip").css({top:"16px"});k("#bullet_tooltip_arr").css({"border-bottom-color":"rgb(95, 97, 106)","border-bottom-style":"solid","border-top-style":"none",top:"-5px","border-bottom":"7px solid rgb(95, 97, 106)"})}else{k("#bullet_tooltip_arr").css({"border-top-color":"#5f616a","border-bottom":"0px",top:"23px","border-bottom-style":"none","border-top-style":"solid"})}}).on("mouseleave",function(){r.remove()})});k(".bullet-recordRow").each(function(){var t=k(this).find(".bullet-record-txt:last");var s=t.text();k(this).on("mouseover",function(){t.text("删除").addClass("bullet-record-link").off("click").click(function(){var u=k(this).parents(".bullet-recordRow").attr("id").substring("bulletId_".length);k.ajax({url:p+"/learn/learnCourseware/deleteLearnVideoBullet.json",type:"post",data:{"params.id":u},dataType:"json",async:true,cache:false,success:function(v){if(v&&v.data.success==="true"){k("#bulletId_"+u).remove()}},error:function(){console.log("删除弹幕请求失败！")}})})}).on("mouseout",function(){t.text(s).removeClass("bullet-record-link")})})}};function a(u,t){if(!(u instanceof Array)){return}var r=u.length;for(var s=r-1;s>-1;s--){if(u[s]==t){u.splice(s,1);break}}return u}function b(r,s){return r.concat(s)}function e(){var t=window.document.location.href;var v=window.document.location.pathname;var u=t.indexOf(v);var r=t.substring(0,u);var s=v.substring(0,v.substr(1).indexOf("/")+1);return(r+s)}function m(y,x){var r=y.length,v=0,u=null;for(var s=0;s<r;s++){var t=y.charCodeAt(s);if(t>0&&t<128){v+=0.5}else{v++}if(parseInt(v)==x){u=s+1}}var w={length:v,limitLenPostion:u};return w}k.fn.videoBullet.defaults={cookieKey:{open:"bullet_open",speed:"bullet_speed",opacity:"bullet_opacity",area:"bullet_area"},userType:0,timePoint:null,pause:null,fullscreen:false,open:"open",speed:10,opacity:80,area:"top",roadCount:5,roadCountAll:12,fontSize:20,sendWaitTime:5,dragTimeLong:3,nowSend:false,nowSendPause:false,screenWidth:function(){return k(".bulletScreen").width()},fullscreenPlay:function(){var r=k(".jwplayer").height();var s=k("#bullet_screen").find(".bulletScreen").css({top:"-10px",height:r});k(".jwplayer").find("#container_caption").append(s)},exitFunllscreenPlay:function(){var r=k(".jwplayer").find("#container_caption").find(".bulletScreen").css({top:"-405px",height:""});k("#bullet_screen").append(r)}}})(jQuery);