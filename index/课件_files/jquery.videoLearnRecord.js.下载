(function(j){var m="wtls_failedRecords";var n=100;var g=2*60*1000;var c=null;var e=false;var k={singleCourseLearnLimited:{msg:"学习记录保存失败！您正在学习其他课程，请关闭当前课程学习页面。",needReload:false},singleItemLearnLimited:{msg:"学习记录保存失败！您正在学习其他节点，请关闭当前课程学习页面。",needReload:false},processCaptureSingleCourseLearnLimited:{msg:"学习记录保存失败！您正在学习其他课程，请关闭当前课程学习页面。",needReload:false},processCaptureSingleTabLearnLimited:{msg:"学习记录保存失败！只能在一个窗口中学习，请关闭当前课程学习页面。",needReload:false},needFaceRecognition:{msg:"学习记录保存失败！人脸识别验证失效，请重新重新验证。",needReload:true},needCaptureEnvironmentDetection:{msg:"学习记录保存失败！抓拍环境检测失效，请重新重新检测",needReload:true}};var a=false;var h=2.2;var b=30;var d=3;var i=0;var o=0;var l={startTime:null,lastEndTime:0,endTime:0};j.defaults=j.extend({},l);var f={setStartTime:function(p){this.debugLog("setStartTime, newVal: "+p);j.defaults.startTime=p},setEndTime:function(p){j.defaults.lastEndTime=j.defaults.endTime;j.defaults.endTime=p},obtainVideoLearnRecordData:function(r){var p={};if(r.interval){this.debugLog("定时任务触发.");p=j.extend({},r,{startTime:j.defaults.startTime,endTime:r.position});this.saveVideoLearnDetailRecord(p);this.setStartTime(p.endTime)}else{if(r.playComplete){this.debugLog("播放完成事件.");p=j.extend({},r,{startTime:j.defaults.startTime,endTime:CommonUtil.timeToSeconds(r.videoTotalTime)});this.saveVideoLearnDetailRecord(p);f.resetInitOption(r)}else{if(r.unloadVideoPage){this.debugLog("页面离开事件. $.defaults.startTime: "+j.defaults.startTime+", $.defaults.endTime: "+j.defaults.endTime+", $.defaults.lastEndTime: "+j.defaults.lastEndTime);if(j.defaults.endTime===0&&j.defaults.lastEndTime>0){this.debugLog("在离开页面事件中发现endTime = 0, params.position: "+r.position);j.defaults.endTime=j.defaults.lastEndTime}p=j.extend({},r,{startTime:j.defaults.startTime,endTime:j.defaults.endTime});this.saveVideoLearnDetailRecord(p)}else{if(r.isSeek){this.debugLog(">>>>>>seek>>>>>>");this.debugLog("$.defaults.startTime: "+j.defaults.startTime);this.debugLog("$.defaults.endTime: "+j.defaults.endTime);this.debugLog("startSeekPosition: "+r.startSeekPosition);this.debugLog("completeSeekPosition: "+r.completeSeekPosition);this.debugLog("params.position: "+r.position);this.debugLog("需要保存的时间段： startTime: "+j.defaults.startTime+", endTime: "+r.startSeekPosition);if(j.defaults.startTime!==null&&r.startSeekPosition!==null){if(!this.isIE()&&r.forbidSeek&&r.maxSeekPosition&&(parseInt(j.defaults.startTime)>parseInt(r.maxSeekPosition))){this.debugLog("开始时间大于最大允许拖动时间点，判定为非法记录.");return}if(r.startSeekPosition-j.defaults.startTime>=d){this.debugLog("seek事件: 保存轨迹, startTime: "+j.defaults.startTime+", endTime: "+r.startSeekPosition);p=j.extend({},r,{startTime:j.defaults.startTime,endTime:r.startSeekPosition});this.saveVideoLearnDetailRecord(p)}else{this.debugLog("seek事件：学习时长不够，取消保存.")}}this.setStartTime(r.completeSeekPosition);this.setEndTime(r.completeSeekPosition)}else{if(j.defaults.startTime===null){this.setStartTime(r.position)}var q=r.position-j.defaults.endTime;if(Math.abs(q)>h){this.debugLog("onTime 判定拖动操作. diff = "+q);if(!this.isIE()&&r.forbidSeek&&r.maxSeekPosition&&(parseInt(j.defaults.startTime)>parseInt(r.maxSeekPosition))){this.debugLog("开始时间大于最大允许拖动时间点，判定为非法记录.");return}p=j.extend({},r,{startTime:j.defaults.startTime,endTime:j.defaults.endTime});if(p.endTime-p.startTime>=d){this.saveVideoLearnDetailRecord(p)}j.defaults.startTime=q>0&&q<b?j.defaults.endTime:r.position}this.setEndTime(r.position)}}}}},saveVideoLearnDetailRecord:function(x){x.studyTimeLong=x.endTime-x.startTime;x.startTimeStr=this.millisecondToTime(x.startTime*1000);x.endTimeStr=this.millisecondToTime(x.endTime*1000);this.debugLog("进入发送请求的方法.");this.debugLog("序列化的options: ");this.debugLog(JSON.stringify(x));if(x.studyTimeLong>0){var t=this.getParams(x);var q="";try{q=CommonUtil.encrypt(j.toJSON(t))}catch(w){alert("学习记录保存失败，请清理缓存并重启浏览器或者更换浏览器后继续学习！[code: 1]");return}var v=this;var p=CommonUtil.getPlatformPath()+"/course/study/learningTime_saveVideoLearnDetailRecord.action";if(x.unloadVideoPage){if(navigator.sendBeacon){var r=new FormData();r.append("studyRecord",q);r.append("limitId",top.limitId);navigator.sendBeacon(p,r)}else{var u=new Image(1,1);u.src=p+"?studyRecord="+encodeURIComponent(q);setTimeout(function(){},1000)}}else{var s=JSON.parse(JSON.stringify(x));j.ajax({url:p,type:"POST",dataType:"json",data:{studyRecord:q,limitId:top.limitId},cache:false,async:x.async!==undefined?x.async:true,success:function(z){if(z&&z.success==="true"){if(z.data&&z.data.timeRecordResult.success==="true"){return}}var y=k[z.info];if(y){alert(y.msg);if(y.needReload){top.location.reload()}}else{v.saveFailedRecordToLocal(s,{logFlag:1,serverInfo:z.info});v.intervalSaveVideoLearnTimesReordData(x)}},error:function(z,A,y){v.saveFailedRecordToLocal(s,{logFlag:2,xhrStatus:z.status});v.intervalSaveVideoLearnTimesReordData(x)}})}}else{this.debugLog("options.studyTimeLong <= 0, 取消保存.")}},intervalSaveVideoLearnTimesReordData:function(p){if(p.studyTimeLong>=0){var s={courseId:p.courseId,itemId:p.itemId,time1:CommonUtil.formatStr(p.studyTimeLong,20),time2:CommonUtil.formatStr(CommonUtil.timeToSeconds(p.videoTotalTime),20)};var q="";try{q=CommonUtil.encrypt(j.toJSON(s))}catch(r){alert("学习记录提交失败，请清理缓存并重启浏览器或者更换浏览器继续学习！");return}j.ajax({url:CommonUtil.getPlatformPath()+"/course/study/learningTime_saveVideoLearnTimeLongRecord.action",type:"POST",dataType:"json",data:{studyRecord:q},cache:false,async:p.async,success:function(t){},error:function(){}})}},millisecondToTime:function(p){if(p!=null&&!isNaN(p)){var q=parseFloat(p)/1000;if(q>0){q=parseInt(q/3600)+":"+parseInt((parseFloat(q/3600)-parseInt(q/3600))*60)+":"+parseInt((parseFloat((parseFloat(q/3600)-parseInt(q/3600))*60)-parseInt((parseFloat(q/3600)-parseInt(q/3600))*60))*60);var r=this.formatTime(q);return r}else{return"00:00:00"}}},getParams:function(p){var q={courseId:p.courseId,itemId:p.itemId,time1:CommonUtil.formatStr((new Date()).getTime(),20),time2:CommonUtil.formatStr(parseInt(p.startTime),20),time3:CommonUtil.formatStr(CommonUtil.timeToSeconds(p.videoTotalTime),20),time4:CommonUtil.formatStr(parseInt(p.endTime),20),videoIndex:p.videoIndex||i,time5:CommonUtil.formatStr(p.studyTimeLong,20),terminalType:p.terminalType||o};return q},formatTime:function(q){var r="";var p=q.split(":");if(p[0].length==1){r+="0"+p[0]+":"}else{r+=p[0]+":"}if(p[1].length==1){r+="0"+p[1]+":"}else{r+=p[1]+":"}if(p[2].length==1){r+="0"+p[2]}else{r+=p[2]}return r},saveFailedRecordToLocal:function(p,q){if(this.isSupportLocalStorage()){var r=localStorage.getItem(m);if(!r){r=[]}else{r=JSON.parse(r)}q.userAgent=navigator.userAgent;p.domain=window.location.host;p.recordTime=(new Date()).getTime();p.otherInfo=q;r.push(p);if(r.length>n){r.splice(0,r.length-n)}localStorage.setItem(m,JSON.stringify(r))}},sendFailedRecordToServer:function(){if(e){return}var p=(new Date()).getTime();if(c===null||p-c>=g){e=true;c=p;var s=localStorage.getItem(m);if(s){var r=JSON.parse(s);if(r.length>0){var q=CommonUtil.getPlatformPath()+"/course/study/learningTime_saveClientFailedRecords.action";j.ajax({url:q,type:"POST",dataType:"json",data:{records:s},cache:false,success:function(t){e=false;if(t.success==="true"){localStorage.removeItem(m)}},error:function(u,v,t){e=false}})}else{e=false}}else{e=false}}},resetInitOption:function(p){if(p.unloadVideoPage||p.playComplete){j.defaults=j.extend({},l)}},isIE:function(){var q=window.navigator.userAgent.toLowerCase();var p=q&&/msie|trident/.test(q);return p},isSupportLocalStorage:function(){return window.Storage&&window.localStorage&&window.localStorage instanceof Storage},debugLog:function(p){if(a){console.log(p)}},};j.fn.videoLearnRecord_enableDebug=function(){a=true};j.fn.videoLearnRecord_disableDebug=function(){a=false};j.fn.videoLearnRecord=function(q){if(q.interval===undefined){q.interval=false}var p=true;if(!q.courseId){console.error("参数缺失: params.courseId");p=false}if(!q.itemId){console.error("参数缺失: params.itemId");p=false}if(q.interval&&!q.position){console.error("参数缺失: params.position, params.interval = true");p=false}if(q.playComplete&&!q.videoTotalTime){console.error("参数缺失: params.videoTotalTime, 播放完成时必须提供该参数");p=false}if(!p){return}f.obtainVideoLearnRecordData(q);f.sendFailedRecordToServer()}})(jQuery);