# !/usr/bin/python3
import time
import requests
import json

from bs4 import BeautifulSoup

# 刷课间隔（秒）
SLEEP_TIME = 1

# 课程 ID
COURSE_ID = '94a30540dc874ad1b3bacef60c957b47'

# 学习时间（建议不改）
STUDY_TIME = '300'

# `learningTime_save` 请求标头 Cookie
COOKIE = 'JSESSIONID=422C3FA181C5D877DAC7416A9FF5A7A2; token=412fa287-33f8-4fe6-9d0e-aaef11f0974e; _abfpc=2c306a55dfa90cf547e6596b6c94af0382cb06e3_2.0; cna=9749e8db40c398e9ea4f825bf100747c; aliyungf_tc=e5e9eccd59bd073b996b065f5cdaac40f5d3d306e77620d2689d5f9409d35a79; acw_tc=2f6fc13116707439269998936e7a79a76be74e20c8967084274aca9ae5e0f6; UNTYXLCOOKIE=dXNlci5pY3ZlLmNvbS5jbnx8MWJkZGEzM2UxYmJlNjExZjc2M2I3MzI0OWUzMmQ5MmV8fGFtc2FrdXJhfHx6aHpq; learning-course=7ba794a577738a15d9330516beb2ae22_94a30540dc874ad1b3bacef60c957b47___; _uid=ec4e3720-c7a6-4426-8a4a-f1fc8d488d26; SERVERID=22293c637420c41b505231fd808611e8|1670744215|1670743927'

if COURSE_ID == '':
    print('请配置 COURSE_ID 后再次运行')
    exit()

if COOKIE == '':
    print('请配置 COOKIE 后再次运行')
    exit()

# 打开文件
html = open('index/生物制药技术.html', mode='r', encoding='utf-8').read()

# 解析为 HTML
document = BeautifulSoup(html, 'html.parser')


# 遍历章
def get_chapters_title():
    chapters_list = []
    for e in document.select('div[id^="s_chapter_"]'):
        chapters_list.append(e.get('title'))
    return chapters_list


# 遍历讲
def get_sections_title():
    sections_list = []
    for e in document.select('div[id^="s_section_"]'):
        sections_list.append(e.get('title'))
    return sections_list


# 遍历讲下节点和资源
def get_points():
    points_list = []
    for e in document.select('div[id^="s_point_"]'):
        # 获取 id 并去掉 s_point_ 前缀
        item_id = e.get('id')[8:]
        if e.select('div[class="s_pointti"]'):
            title = e.select('div[class="s_pointti"]')[0].contents[0].text
        else:
            title = e.select('div[class="s_pointtitle"]')[0].contents[0].text
        points_list.append(Point(item_id, title if title else "未知标题"))
    return points_list


class Point:
    itemId = ''
    title = ''

    def __init__(self, item_id, title):
        self.itemId = item_id
        self.title = title

    def __str__(self):
        return self.title + "：" + self.itemId


for i in get_points():
    print(i)
    course_id = requests.get(
        url='https://course.icve.com.cn/learnspace/course/study/learningTime_queryCourseItemInfo.action',
        headers={'Cookie': COOKIE},
        params={'itemId': i.itemId},
    ).text
    print(course_id)
    print(requests.post(
        url='https://course.icve.com.cn/learnspace/course/study/learningTime_saveCourseItemLearnRecord.action',
        # cookies=COOKIE,
        headers={
            # "cookie": COOKIE,
            "Cookie": COOKIE,
            # "Accept": "*/*",
            # "Accept-Encoding": "gzip, deflate, br",
            # "Accept-Language": "zh-CN,zh;q=0.9",
            # "Connection": "keep-alive",
            # "Content-Type": "multipart/form-data",
            # "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36",
            # "Referer": "https://course.icve.com.cn/learnspace/learn/learn/templateeight/content_doc.action?params.courseId=6937939f1dfe4af7aef45cc9dcc2459e___&params.itemId=402883a982e2a5660182f2f78269381c&params.templateStyleType=0&params.parentId=1563079671446114306&_t=1667738504796"
        },
        data={
            "courseId": COURSE_ID,
            "studyTime": STUDY_TIME,
            "itemId": i.itemId,
            "recordType": "0"
        },
    ).text)

    time.sleep(SLEEP_TIME)
